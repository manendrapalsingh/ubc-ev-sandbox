# BPP-specific values for onix-api-microservice
component: bpp

image:
  repository: manendrapalsingh/onix-bpp-plugin
  tag: latest

service:
  port: 8002
  targetPort: 8002

redis:
  enabled: true
  service:
    port: 6379

# BPP Adapter Configuration
config:
  adapter: |
    appName: "onix-ev-charging"
    
    log:
      level: debug
      destinations:
        - type: stdout
      contextKeys:
        - transaction_id
        - message_id
        - subscriber_id
        - module_id
    
    http:
      port: 8002
      timeout:
        read: 30
        write: 30
        idle: 30
    
    pluginManager:
      root: /app/plugins
    
    modules:
      # BPP Receiver - Receives search from CDS and other requests from ONIX
      - name: bppTxnReceiver
        path: /bpp/receiver/
        handler:
          type: std
          role: bpp
          httpClientConfig:
            maxIdleConns: 1000
            maxIdleConnsPerHost: 200
            idleConnTimeout: 300s
            responseHeaderTimeout: 5s
          plugins:
            registry:
              id: registry
              config:
                url: http://ev-charging-mock-registry:3030
                retry_max: 3
                retry_wait_min: 100ms
                retry_wait_max: 500ms
            keyManager:
              id: simplekeymanager
              config:
                networkParticipant: ev-charging.sandbox2.com
                keyId: bpp-key-1
                signingPrivateKey: xnKF3BIg3Ei+ZEvxBtK0Mm4GRG1Mr0+K9IrxT6CnHEE=
                signingPublicKey: MKA6fln8vmU2Qn80Y7dLzagpaPNqQWOlvGglMo5s0IU=
                encrPrivateKey: xnKF3BIg3Ei+ZEvxBtK0Mm4GRG1Mr0+K9IrxT6CnHEE=
                encrPublicKey: MKA6fln8vmU2Qn80Y7dLzagpaPNqQWOlvGglMo5s0IU=
            cache:
              id: cache
              config:
                addr: REDIS_HOST_PLACEHOLDER:6379
            schemaValidator:
              id: schemavalidator
              config:
                schemaDir: /app/schemas
            signValidator:
              id: signvalidator
            router:
              id: router
              config:
                routingConfig: /app/config/onix-bpp/bpp_receiver_routing.yaml
            middleware:
              - id: reqpreprocessor
                config:
                  uuidKeys: transaction_id,message_id
                  role: bpp
          steps:
            - validateSign
            - addRoute
            - validateSchema

      
      # BPP Caller - Sends responses (on_search, on_select, on_init, etc.) to CDS/ONIX
      - name: bppTxnCaller
        path: /bpp/caller/
        handler:
          type: std
          role: bpp
          httpClientConfig:
            maxIdleConns: 1000
            maxIdleConnsPerHost: 200
            idleConnTimeout: 300s
            responseHeaderTimeout: 5s
          plugins:
            registry:
              id: registry
              config:
                url: http://ev-charging-mock-registry:3030
                retry_max: 3
                retry_wait_min: 100ms
                retry_wait_max: 500ms
            keyManager:
              id: simplekeymanager
              config:
                networkParticipant: ev-charging.sandbox2.com
                keyId: bpp-key-1
                signingPrivateKey: xnKF3BIg3Ei+ZEvxBtK0Mm4GRG1Mr0+K9IrxT6CnHEE=
                signingPublicKey: MKA6fln8vmU2Qn80Y7dLzagpaPNqQWOlvGglMo5s0IU=
                encrPrivateKey: xnKF3BIg3Ei+ZEvxBtK0Mm4GRG1Mr0+K9IrxT6CnHEE=
                encrPublicKey: MKA6fln8vmU2Qn80Y7dLzagpaPNqQWOlvGglMo5s0IU=
            cache:
              id: cache
              config:
                addr: REDIS_HOST_PLACEHOLDER:6379
            schemaValidator:
              id: schemavalidator
              config:
                schemaDir: /app/schemas
            router:
              id: router
              config:
                routingConfig: /app/config/onix-bpp/bpp_caller_routing.yaml
            signer:
              id: signer
            middleware:
              - id: reqpreprocessor
                config:
                  uuidKeys: transaction_id,message_id
                  role: bpp
          steps:
            - addRoute
            - sign

  routing:
    caller: |
      # BPP Caller Routing Configuration
      # Microservice Architecture: Routes to BAP service, which then routes to different mock BAP services
      
      routingRules:
        # Phase 1: on_discover response routes to CDS
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-cds:8082/csd
            excludeAction: false
          endpoints:
            - on_discover
      
        # Phase 2+: Each response routes to BAP receiver, which then routes to different mock BAP services
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-bap-onix-api-microservice-bap-service:8001/bap/receiver
            excludeAction: false
          endpoints:
            - on_select
            - on_init
            - on_confirm
            - on_status
            - on_track
            - on_cancel
            - on_update
            - on_rating
            - on_support
    
    receiver: |
      # ONIX BPP Receiver Routing Configuration
      # Microservice Architecture: Each request routes to different mock BPP services
      # Note: The router automatically appends the endpoint name to the base URL
      # Example: url: http://ev-charging-mock-bpp-confirm:9014 + endpoint "confirm" 
      #          results in: http://ev-charging-mock-bpp-confirm:9014/confirm
      
      routingRules:
        # Phase 1: Discover request from CDS routes to mock-bpp-discover
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-discover:9011
            excludeAction: false
          endpoints:
            - discover
      
        # Phase 2+: Each request routes to different mock BPP services
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-select:9012
            excludeAction: false
          endpoints:
            - select
      
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-init:9013
            excludeAction: false
          endpoints:
            - init
      
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-confirm:9014
            excludeAction: false
          endpoints:
            - confirm
      
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-status:9015
            excludeAction: false
          endpoints:
            - status
      
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-track:9016
            excludeAction: false
          endpoints:
            - track
      
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-cancel:9017
            excludeAction: false
          endpoints:
            - cancel
      
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-update:9018
            excludeAction: false
          endpoints:
            - update
      
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-rating:9019
            excludeAction: false
          endpoints:
            - rating
      
        - domain: beckn.one:deg:ev-charging
          version: "2.0.0"
          targetType: url
          target:
            url: http://ev-charging-mock-bpp-support:9020
            excludeAction: false
          endpoints:
            - support

