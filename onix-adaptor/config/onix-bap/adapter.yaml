appName: "onix-ev-charging"

log:
  level: debug
  destinations:
    - type: stdout
  contextKeys:
    - transaction_id
    - message_id
    - subscriber_id
    - module_id
    - parent_id

http:
  port: 8001
  timeout:
    read: 30
    write: 30
    idle: 30

pluginManager:
  root: /app/plugins

plugins:
  otelsetup:
    id: otelsetup
    config:
      serviceName: "beckn-onix"
      serviceVersion: "1.0.0"
      enableMetrics: "true"
      environment: "development"
      metricsPort: "9003"

modules:
  # BAP Receiver - Receives callbacks from CDS (Phase 1) and BPPs (Phase 2+)
  # Phase 1: Receives on_search from CDS with aggregated catalog
  # Phase 2+: Receives callbacks from BPPs (on_select, on_init, on_confirm, etc.)
  - name: bapTxnReceiver
    path: /bap/receiver/
    handler:
      type: std
      role: bap
      subscriberId: ev-charging.sandbox1.com
      httpClientConfig:
        maxIdleConns: 1000
        maxIdleConnsPerHost: 200
        idleConnTimeout: 300s
        responseHeaderTimeout: 5s
      plugins:
        registry:
          id: registry
          config:
            url: http://mock-registry:3030
            retry_max: 3
            retry_wait_min: 100ms
            retry_wait_max: 500ms
         # this is for the dedi registry     
        # registry:
        #   id: dediregistry
        #   config:
        #     url: http://api.testnet.beckn.one/dedi
        #     registryName: subscribers.beckn.one
        #     retry_max: 3
        #     retry_wait_min: 100ms
        #     retry_wait_max: 500ms
        keyManager:
          id: simplekeymanager
          config:
            networkParticipant: ev-charging.sandbox1.com
            keyId: bap-key-1
            signingPrivateKey: kaOxmZvVK0IdfMa+OtKZShKo9KVk4QLgCMn+Ch4QpU4=
            signingPublicKey: ehNGIiQxbhAJGS9U7YZN5nsUNiLDlaSUQWlWbWc4SO4=
            encrPrivateKey: kaOxmZvVK0IdfMa+OtKZShKo9KVk4QLgCMn+Ch4QpU4=
            encrPublicKey: ehNGIiQxbhAJGS9U7YZN5nsUNiLDlaSUQWlWbWc4SO4=
        cache:
          id: cache
          config:
            addr: redis-onix-bap:6379
        schemaValidator:
          id: schemav2validator
          config:
            type: url
            location: https://raw.githubusercontent.com/beckn/protocol-specifications-v2/refs/heads/core-v2.0.0-rc/api/beckn.yaml
            cacheTTL: "3600"
            extendedSchema_enabled: "true"
            extendedSchema_cacheTTL: "86400"
            extendedSchema_maxCacheSize: "100"
            extendedSchema_downloadTimeout: "30"
            extendedSchema_allowedDomains: "beckn.org,example.com,raw.githubusercontent.com"
        signValidator:
          id: signvalidator
        router:
          id: router
          config:
            routingConfig: /app/config/bap_receiver_routing.yaml
        middleware:
          - id: reqpreprocessor
            config:
              contextKeys: transaction_id,message_id,parent_id
              role: bap
      steps:
        - validateSign
        - addRoute
        - validateSchema

  # BAP Caller - Entry point for all requests from BAP
  # Phase 1: Routes search to external CDS for aggregation
  # Phase 2+: Routes other requests directly to BPP (bypasses CDS)
  # Uses bpp_uri from context for dynamic routing in Phase 2+
  - name: bapTxnCaller
    path: /bap/caller/
    handler:
      type: std
      role: bap
      subscriberId: ev-charging.sandbox1.com
      httpClientConfig:
        maxIdleConns: 1000
        maxIdleConnsPerHost: 200
        idleConnTimeout: 300s
        responseHeaderTimeout: 5s
      plugins:
        registry:
          id: registry
          config:
            url: http://mock-registry:3030
            retry_max: 3
            retry_wait_min: 100ms
            retry_wait_max: 500ms
        # this is for the dedi registry     
        # registry:
        #   id: dediregistry
        #   config:
        #     url: http://api.testnet.beckn.one/dedi
        #     registryName: subscribers.beckn.one
        #     retry_max: 3
        #     retry_wait_min: 100ms
        #     retry_wait_max: 500ms
        keyManager:
          id: simplekeymanager
          config:
            networkParticipant: ev-charging.sandbox1.com
            keyId: bap-key-1
            signingPrivateKey: kaOxmZvVK0IdfMa+OtKZShKo9KVk4QLgCMn+Ch4QpU4=
            signingPublicKey: ehNGIiQxbhAJGS9U7YZN5nsUNiLDlaSUQWlWbWc4SO4=
            encrPrivateKey: kaOxmZvVK0IdfMa+OtKZShKo9KVk4QLgCMn+Ch4QpU4=
            encrPublicKey: ehNGIiQxbhAJGS9U7YZN5nsUNiLDlaSUQWlWbWc4SO4=
        cache:
          id: cache
          config:
            addr: redis-onix-bap:6379
        schemaValidator:
          id: schemav2validator
          config:
            type: url
            location: https://raw.githubusercontent.com/beckn/protocol-specifications-v2/refs/heads/core-v2.0.0-rc/api/beckn.yaml
            cacheTTL: "3600"
            extendedSchema_enabled: "true"
            extendedSchema_cacheTTL: "86400"
            extendedSchema_maxCacheSize: "100"
            extendedSchema_downloadTimeout: "30"
            extendedSchema_allowedDomains: "beckn.org,example.com,raw.githubusercontent.com"
        router:
          id: router
          config:
            routingConfig: /app/config/bap_caller_routing.yaml
        signer:
          id: signer
        middleware:
          - id: reqpreprocessor
            config:
              contextKeys: transaction_id,message_id,parent_id
              role: bap
      steps:
        - validateSchema
        - addRoute
        - sign

