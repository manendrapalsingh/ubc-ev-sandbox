appName: "onix-ev-charging"

log:
  level: debug
  destinations:
    - type: stdout
  contextKeys:
    - transaction_id
    - message_id
    - subscriber_id
    - module_id

# HTTP configuration is required for bapTxnReceiver to receive HTTP requests from BPP-ONIX plugin
# The bapTxnReceiver module uses handler type "std" which requires HTTP server
http:
  port: 8001
  timeout:
    read: 30
    write: 30
    idle: 30

pluginManager:
  root: /app/plugins

plugins:
  otelsetup:
    id: otelsetup
    config:
      serviceName: "beckn-onix"
      serviceVersion: "1.0.0"
      enableMetrics: "true"
      environment: "development"
      metricsPort: "9003"

modules:
  # BAP Receiver - Receives HTTP requests from BPP-ONIX and publishes to BAP Backend via Kafka
  # Phase 1: Receives on_discover from CDS with aggregated catalog
  # Phase 2+: Receives callbacks from BPPs (on_select, on_init, on_confirm, etc.)
  - name: bapTxnReceiver
    path: /bap/receiver/
    handler:
      type: std
      role: bap
      subscriberId: ev-charging.sandbox1.com
      httpClientConfig:
        maxIdleConns: 1000
        maxIdleConnsPerHost: 200
        idleConnTimeout: 300s
        responseHeaderTimeout: 5s
      plugins:
        registry:
          id: registry
          config:
            url: http://mock-registry:3030
            retry_max: 3
            retry_wait_min: 100ms
            retry_wait_max: 500ms
        keyManager:
          id: simplekeymanager
          config:
            networkParticipant: ev-charging.sandbox1.com
            keyId: bap-key-1
            signingPrivateKey: xnKF3BIg3Ei+ZEvxBtK0Mm4GRG1Mr0+K9IrxT6CnHEE=
            signingPublicKey: MKA6fln8vmU2Qn80Y7dLzagpaPNqQWOlvGglMo5s0IU=
            encrPrivateKey: xnKF3BIg3Ei+ZEvxBtK0Mm4GRG1Mr0+K9IrxT6CnHEE=
            encrPublicKey: MKA6fln8vmU2Qn80Y7dLzagpaPNqQWOlvGglMo5s0IU=
        cache:
          id: cache
          config:
            addr: redis-bap:6379
        schemaValidator:
          id: schemav2validator
          config:
            type: url
            location: https://raw.githubusercontent.com/beckn/protocol-specifications-v2/refs/heads/core-v2.0.0-rc/api/beckn.yaml
            cacheTTL: "3600"
            extendedSchema_enabled: "true"
            extendedSchema_cacheTTL: "86400"
            extendedSchema_maxCacheSize: "100"
            extendedSchema_downloadTimeout: "30"
            extendedSchema_allowedDomains: "beckn.org,example.com,raw.githubusercontent.com"
        # signValidator:
        #   id: signvalidator
        router:
          id: router
          config:
            routingConfig: /app/config/bapTxnReciever-routing.yaml
        publisher:
          id: publisher
          config:
            type: kafka
            brokers: kafka:9092
            topic: bap.on_default
            compressionCodec: snappy
            acks: all
            retries: "2147483647"
            retryBackoffMs: "100"
            deliveryTimeoutMs: "120000"
            enableIdempotence: "true"
            admin.enabled: "on"
            admin.topicSpecs: '[{"topic":"bap.on_discover","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_select","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_init","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_confirm","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_status","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_track","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_cancel","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_update","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_rating","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_support","numPartitions":1,"replicationFactor":1},{"topic":"bap.on_default","numPartitions":1,"replicationFactor":1}]'
        middleware:
          - id: reqpreprocessor
            config:
              uuidKeys: transaction_id,message_id
              role: bap
      steps:
        # - validateSign
        - validateSchema
        - addRoute

  # BAP Caller - Consumes requests from BAP Backend via Kafka and routes them outward
  # Phase 1: Routes discover to external CDS for aggregation
  # Phase 2+: Routes other requests directly to BPP (bypasses CDS)
  # Uses bpp_uri from context for dynamic routing in Phase 2+
  - name: bapTxnCaller
    path: ""  # path is not used for queue handlers
    handler:
      type: queue
      role: bap
      subscriberId: ev-charging.sandbox1.com
      httpClientConfig:
        maxIdleConns: 1000
        maxIdleConnsPerHost: 200
        idleConnTimeout: 300s
        responseHeaderTimeout: 5s
      plugins:
        registry:
          id: registry
          config:
            url: http://mock-registry:3030
            retry_max: 3
            retry_wait_min: 100ms
            retry_wait_max: 500ms
        keyManager:
          id: simplekeymanager
          config:
            networkParticipant: ev-charging.sandbox1.com
            keyId: bap-key-1
            signingPrivateKey: xnKF3BIg3Ei+ZEvxBtK0Mm4GRG1Mr0+K9IrxT6CnHEE=
            signingPublicKey: MKA6fln8vmU2Qn80Y7dLzagpaPNqQWOlvGglMo5s0IU=
            encrPrivateKey: xnKF3BIg3Ei+ZEvxBtK0Mm4GRG1Mr0+K9IrxT6CnHEE=
            encrPublicKey: MKA6fln8vmU2Qn80Y7dLzagpaPNqQWOlvGglMo5s0IU=
        cache:
          id: cache
          config:
            addr: redis-bap:6379
        schemaValidator:
          id: schemav2validator
          config:
            type: url
            location: https://raw.githubusercontent.com/beckn/protocol-specifications-v2/refs/heads/core-v2.0.0-rc/api/beckn.yaml
            cacheTTL: "3600"
            extendedSchema_enabled: "true"
            extendedSchema_cacheTTL: "86400"
            extendedSchema_maxCacheSize: "100"
            extendedSchema_downloadTimeout: "30"
            extendedSchema_allowedDomains: "beckn.org,example.com,raw.githubusercontent.com"
        consumer:
          id: consumer
          config:
            subscriberId: ev-charging.sandbox1.com
            role: bap
            consumerType: kafka
            consumerThreads: "2"
            consumer.id: kafkaconsumer
            consumer.brokers: kafka:9092
            consumer.topics: "bap.discover,bap.select,bap.init,bap.confirm,bap.status,bap.track,bap.cancel,bap.update,bap.rating,bap.support"
            consumer.groupId: bap_caller_group
            consumer.autoCommit: "false"
            consumer.commitInterval: "10s"
            consumer.sessionTimeout: "10s"
            consumer.heartbeatInterval: "1s"
            consumer.maxPollInterval: "5m"
            consumer.rebalanceTimeout: "30s"
            consumer.fetchMinBytes: "1024"
            consumer.fetchMaxWaitTime: "500ms"
            consumer.maxPartitionFetchBytes: "131072"
            consumer.maxRetry: "3"
            consumer.useTLS: "false"
            consumer.tlsInsecureSkipVerify: "false"
            consumer.tlsCAFile: ""
            consumer.tlsCertFile: ""
            consumer.tlsKeyFile: ""
            consumer.dialTimeout: "5s"
            consumer.admin.enabled: "on"
            consumer.admin.topicSpecs: '[{"topic":"bap.discover","numPartitions":1,"replicationFactor":1},{"topic":"bap.select","numPartitions":1,"replicationFactor":1},{"topic":"bap.init","numPartitions":1,"replicationFactor":1},{"topic":"bap.confirm","numPartitions":1,"replicationFactor":1},{"topic":"bap.status","numPartitions":1,"replicationFactor":1},{"topic":"bap.track","numPartitions":1,"replicationFactor":1},{"topic":"bap.cancel","numPartitions":1,"replicationFactor":1},{"topic":"bap.update","numPartitions":1,"replicationFactor":1},{"topic":"bap.rating","numPartitions":1,"replicationFactor":1},{"topic":"bap.support","numPartitions":1,"replicationFactor":1}]'
            steps: '["addRoute", "validateSchema", "sign"]'
        router:
          id: router
          config:
            routingConfig: /app/config/bapTxnCaller-routing.yaml
        signer:
          id: signer
        middleware:
          - id: reqpreprocessor
            config:
              uuidKeys: transaction_id,message_id
              role: bap
      steps:
        - validateSchema
        - addRoute
        - sign

