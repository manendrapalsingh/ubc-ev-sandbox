version: '3.9'

services:
  # Redis for onix-bap-plugin
  redis-onix-bap:
    image: redis:alpine
    pull_policy: always
    container_name: redis-onix-bap
    ports:
      - "6379:6379"
    networks:
      - onix-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Redis for onix-bpp-plugin
  redis-onix-bpp:
    image: redis:alpine
    pull_policy: always
    container_name: redis-onix-bpp
    ports:
      - "6380:6379"
    networks:
      - onix-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Onix BAP Plugin
  onix-bap-plugin:
    image: manendrapalsingh/onix-adapter:v0.9.0
    pull_policy: always
    container_name: onix-bap-plugin
    ports:
      - "8001:8001"
      - "9003:9003"
    volumes:
      # Mount config directory (writable for symlink creation, but original files won't be modified)
      - ${CONFIG_PATH:-../onix-adaptor/config}/onix-bap:/app/config
      # Mount schema directory (read-only)
      - ../schemas:/app/schemas:ro
    environment:
      - CONFIG_FILE=/app/config/adapter.yaml
      - REDIS_PASSWORD=your-redis-password
    restart: unless-stopped
    depends_on:
      redis-onix-bap:
        condition: service_healthy
      mock-registry:
        condition: service_healthy
    networks:
      - onix-network

  # Onix BPP Plugin
  onix-bpp-plugin:
    image: manendrapalsingh/onix-adapter:v0.9.0
    pull_policy: always
    container_name: onix-bpp-plugin
    ports:
      - "8002:8002"
      - "9004:9004"
    volumes:
      # Mount config directory (writable for symlink creation, but original files won't be modified)
      - ${CONFIG_PATH:-../onix-adaptor/config}/onix-bpp:/app/config
      # Mount schema directory (read-only)
      - ../schemas:/app/schemas:ro
    environment:
      - CONFIG_FILE=/app/config/adapter.yaml
      - REDIS_PASSWORD=your-redis-password
    restart: unless-stopped
    depends_on:
      redis-onix-bpp:
        condition: service_healthy
      mock-registry:
        condition: service_healthy
    networks:
      - onix-network

  # Mock CDS Service
  mock-cds:
    image: manendrapalsingh/mock-cds:latest
    pull_policy: always
    container_name: mock-cds
    ports:
      - "8082:8082"
    volumes:
      # Mount config file from local directory
      - ./mock-cds_config.yml:/app/config/config.yaml:ro
    networks:
      - onix-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      mock-registry:
        condition: service_healthy

  # Mock Registry Service
  mock-registry:
    image: manendrapalsingh/mock-registry:latest
    pull_policy: always
    container_name: mock-registry
    ports:
      - "3030:3030"
    volumes:
      # Mount config file from local directory
      - ./mock-registry_config.yml:/app/config/config.yaml:ro
    networks:
      - onix-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3030/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Mock BAP Service
  mock-bap:
    image: manendrapalsingh/mock-bap:latest
    pull_policy: always
    container_name: mock-bap
    ports:
      - "9001:9001"
    volumes:
      # Mount config file from local directory
      - ./mock-bap_config.yml:/app/config/config.yaml:ro
    networks:
      - onix-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Mock BPP Service
  mock-bpp:
    image: manendrapalsingh/mock-bpp:latest
    pull_policy: always
    container_name: mock-bpp
    ports:
      - "9002:9002"
    volumes:
      # Mount config file from local directory
      - ./mock-bpp_config.yml:/app/config/config.yaml:ro
      # Mount request.json file (resolves to /app/config/request.json in container)
      - ./request.json:/app/config/request.json:ro
    networks:
      - onix-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  onix-network:
    driver: bridge

